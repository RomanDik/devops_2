name: CD

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to server
      uses: appleboy/ssh-action@v1
      with:
        host: course.prafdin.ru
        username: vboxuser
        port: 2425
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "=== Starting deployment ==="
          
          # Переходим в домашнюю директорию
          cd /home/vboxuser
          
          # Останавливаем предыдущие процессы Python на порту 8181
          echo "Stopping previous processes..."
          sudo pkill -f "python.*app.py" || true
          sleep 3
          
          # Проверяем, остались ли процессы
          if pgrep -f "python.*app.py" > /dev/null; then
            echo "Force killing remaining processes..."
            sudo pkill -9 -f "python.*app.py" || true
            sleep 2
          fi
          
          # Клонируем или обновляем репозиторий
          echo "Updating code..."
          if [ -d "devops-lab1" ]; then
            cd devops-lab1
            git fetch origin
            git reset --hard origin/main
          else
            git clone https://github.com/RomanDik/devops_2.git devops-lab1
            cd devops-lab1
          fi
          
          # Проверяем что файл app.py существует
          ls -la
          echo "Current directory: $(pwd)"
          
          # Запускаем приложение в фоне
          echo "Starting application..."
          nohup python3 app.py > app.log 2>&1 &
          
          # Даем время на запуск
          sleep 5
          
          # Проверяем что процесс запустился
          echo "Checking if process is running..."
          if pgrep -f "python.*app.py" > /dev/null; then
            echo "✓ Application process is running"
          else
            echo "✗ Application failed to start"
            echo "=== App log content ==="
            cat app.log || true
            exit 1
          fi
          
          # Проверяем что приложение отвечает на порту 8181
          echo "Testing application on port 8181..."
          if curl -f http://localhost:8181 > /dev/null 2>&1; then
            echo "✓ Application is responding on port 8181"
          else
            echo "✗ Application not responding on port 8181"
            echo "=== Checking netstat ==="
            netstat -tlnp | grep :8181 || true
            exit 1
          fi
          
          echo "=== Deployment completed successfully ==="