name: CD

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: Copy application files via SCP
      run: |
        ssh -o StrictHostKeyChecking=no -p 2425 vboxuser@course.prafdin.ru 'mkdir -p /home/vboxuser/devops-app'
        scp -o StrictHostKeyChecking=no -P 2425 -r ./* vboxuser@course.prafdin.ru:/home/vboxuser/devops-app/
    
    - name: Deploy and start service
      run: |
        ssh -o StrictHostKeyChecking=no -p 2425 vboxuser@course.prafdin.ru 'bash -s' << 'EOF'
        cd /home/vboxuser/devops-app
        
        DEPLOY_TIME=$(date '+%Y-%m-%d %H:%M:%S')
        
        # Останавливаем и очищаем
        sudo systemctl stop devops-app.service || true
        sudo pkill -f "python.*app.py" || true
        sleep 3
        
        # Создаем/обновляем сервис
        sudo tee /etc/systemd/system/devops-app.service > /dev/null << 'SERVICEEOF'
        [Unit]
        Description=DevOps Lab Application
        After=network.target

        [Service]
        Type=simple
        User=vboxuser
        WorkingDirectory=/home/vboxuser/devops-app
        Environment=DEPLOY_TIME=$DEPLOY_TIME
        ExecStart=/usr/bin/python3 /home/vboxuser/devops-app/app.py
        Restart=on-failure
        RestartSec=5
        StandardOutput=journal
        StandardError=journal

        [Install]
        WantedBy=multi-user.target
        SERVICEEOF

        sudo systemctl daemon-reload
        sudo systemctl enable devops-app.service
        sudo systemctl start devops-app.service
        
        # ПРОСТАЯ ПРОВЕРКА - только что процесс запущен
        sleep 5
        if pgrep -f "python.*app.py" > /dev/null; then
          echo "Service deployed successfully!"
          echo "Deployed at: $DEPLOY_TIME"
          echo "Check manually: http://app.dik.course.prafdin.ru"
          exit 0  # УСПЕХ!
        else
          echo "Service failed to start"
          sudo journalctl -u devops-app.service -n 10 --no-pager
          exit 1
        fi
        EOF