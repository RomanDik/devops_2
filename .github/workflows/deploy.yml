name: CD

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: Copy application files via SCP
      run: |
        ssh -o StrictHostKeyChecking=no -p 2425 vboxuser@course.prafdin.ru 'mkdir -p /home/vboxuser/devops-app'
        scp -o StrictHostKeyChecking=no -P 2425 -r ./* vboxuser@course.prafdin.ru:/home/vboxuser/devops-app/
    
    - name: Deploy and start service
      run: |
        ssh -o StrictHostKeyChecking=no -p 2425 vboxuser@course.prafdin.ru 'bash -s' << 'EOF'
        cd /home/vboxuser/devops-app
        
        DEPLOY_TIME=$(date '+%Y-%m-%d %H:%M:%S')
        
        # Останавливаем сервис и ждем освобождения порта
        echo "Stopping existing service..."
        sudo systemctl stop devops-app.service || true
        
        # Убиваем все процессы на порту 8181
        echo "Killing any processes on port 8181..."
        sudo pkill -f "python.*app.py" || true
        sleep 3
        
        # Проверяем что порт свободен
        if sudo lsof -i :8181 > /dev/null 2>&1; then
          echo "Port 8181 is still in use, forcing cleanup..."
          sudo fuser -k 8181/tcp || true
          sleep 2
        fi
        
        # Создаем systemd сервис
        sudo tee /etc/systemd/system/devops-app.service > /dev/null << 'SERVICEEOF'
        [Unit]
        Description=DevOps Lab Application
        After=network.target

        [Service]
        Type=simple
        User=vboxuser
        WorkingDirectory=/home/vboxuser/devops-app
        Environment=DEPLOY_TIME=$DEPLOY_TIME
        ExecStart=/usr/bin/python3 /home/vboxuser/devops-app/app.py
        Restart=always
        RestartSec=5
        StandardOutput=journal
        StandardError=journal

        [Install]
        WantedBy=multi-user.target
        SERVICEEOF

        # Настраиваем и запускаем сервис
        sudo systemctl daemon-reload
        sudo systemctl enable devops-app.service
        sudo systemctl start devops-app.service
        
        # Даем время на запуск
        sleep 5
        
        # Проверяем статус
        echo "=== Service status ==="
        sudo systemctl status devops-app.service --no-pager
        
        # Проверяем что приложение работает
        if curl -f http://localhost:8181 > /dev/null 2>&1; then
          echo "Application deployed and running via systemd service!"
          echo "Deployed at: $DEPLOY_TIME"
        else
          echo "Application failed to start"
          sudo journalctl -u devops-app.service -n 15 --no-pager
          exit 1
        fi
        EOF