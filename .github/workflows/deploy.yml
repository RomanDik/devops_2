name: CD

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: Deploy application
      run: |
        ssh -o StrictHostKeyChecking=no -p 2425 vboxuser@course.prafdin.ru 'bash -s' << 'EOF'
        cd /home/vboxuser
        
        # Останавливаем старые процессы
        pkill -f "python.*app.py" || true
        sleep 2
        
        # Создаем папку и файл
        mkdir -p devops-app
        cd devops-app
        
        # Создаем app.py с правильными отступами
        cat > app.py << 'APPEOF'
        import http.server
        import socketserver

        PORT = 8181

        class SimpleHandler(http.server.SimpleHTTPRequestHandler):
            def do_GET(self):
                self.send_response(200)
                self.send_header('Content-type', 'text/html')
                self.end_headers()
                html_content = "<html><body><h1>DevOps Lab #2 - GitHub Actions CD</h1><p>Deployed via release pipeline</p></body></html>"
                self.wfile.write(html_content.encode())

        with socketserver.TCPServer(("", PORT), SimpleHandler) as httpd:
            print(f"Server on port {PORT}")
            httpd.serve_forever()
        APPEOF

        # Запускаем
        nohup python3 app.py > app.log 2>&1 &
        sleep 5
        
        # Проверяем
        if pgrep -f "python.*app.py" > /dev/null; then
          echo "Deployment successful!"
        else
          echo "Deployment failed"
          exit 1
        fi
        EOF