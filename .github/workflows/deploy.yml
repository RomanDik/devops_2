name: CD

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to server
      uses: appleboy/ssh-action@v1
      with:
        host: course.prafdin.ru
        username: vboxuser
        port: 2425
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "=== Starting deployment ==="
          cd /home/vboxuser
          pwd
          ls -la
          
          # Останавливаем предыдущие процессы Python на порту 8181
          echo "Stopping previous processes..."
          pkill -f "python.*app.py" || true
          sleep 2
          
          # Создаем папку для приложения если её нет
          if [ ! -d "devops-app" ]; then
            echo "Creating devops-app directory..."
            mkdir -p devops-app
          fi
          
          cd devops-app
          echo "Current directory: $(pwd)"
          
          # Копируем файлы напрямую через scp (альтернативный способ)
          echo "Copying application files..."
          cat > app.py << 'EOF'
import http.server
import socketserver

PORT = 8181

class SimpleHandler(http.server.SimpleHTTPRequestHandler):
    def do_GET(self):
        self.send_response(200)
        self.send_header('Content-type', 'text/html')
        self.end_headers()
        
        html_content = '''
        <!DOCTYPE html>
        <html>
        <head>
            <title>DevOps Lab #2</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 40px; }
                .container { max-width: 800px; margin: 0 auto; }
                .success { color: green; font-weight: bold; }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>DevOps Laboratory Work #2</h1>
                <p><strong>Student:</strong> dik</p>
                <p class="success">Successfully deployed via GitHub Actions!</p>
                <p>This page updates automatically when you create a release.</p>
                <p><strong>App URL:</strong> http://app.dik.course.prafdin.ru</p>
                <p><strong>Deployment:</strong> GitHub Actions CD Pipeline</p>
            </div>
        </body>
        </html>
        '''
        
        self.wfile.write(html_content.encode())

with socketserver.TCPServer(("", PORT), SimpleHandler) as httpd:
    print(f"Server running on port {PORT}")
    httpd.serve_forever()
EOF

          # Проверяем что файл создался
          ls -la
          echo "File content:"
          head -20 app.py
          
          # Запускаем приложение в фоне
          echo "Starting application..."
          nohup python3 app.py > app.log 2>&1 &
          
          # Даем время на запуск
          sleep 5
          
          # Проверяем что процесс запустился
          echo "Checking if process is running..."
          if pgrep -f "python.*app.py" > /dev/null; then
            echo "✓ Application process is running"
            echo "Process info:"
            ps aux | grep python | grep app.py
          else
            echo "✗ Application failed to start"
            echo "=== App log content ==="
            cat app.log || true
            exit 1
          fi
          
          # Проверяем что приложение отвечает на порту 8181
          echo "Testing application on port 8181..."
          if curl -f http://localhost:8181 > /dev/null 2>&1; then
            echo "✓ Application is responding on port 8181"
          else
            echo "✗ Application not responding on port 8181"
            echo "=== Checking netstat ==="
            netstat -tlnp | grep :8181 || true
            echo "=== Checking listening ports ==="
            ss -tlnp | grep :8181 || true
            exit 1
          fi
          
          echo "=== Deployment completed successfully ==="