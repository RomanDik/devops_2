name: CD

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
    
    - name: Copy application files via SCP
      run: |
        ssh -o StrictHostKeyChecking=no -p 2425 vboxuser@course.prafdin.ru 'mkdir -p /home/vboxuser/devops-app'
        scp -o StrictHostKeyChecking=no -P 2425 -r ./* vboxuser@course.prafdin.ru:/home/vboxuser/devops-app/
    
    - name: Deploy and start service
      run: |
        ssh -o StrictHostKeyChecking=no -p 2425 vboxuser@course.prafdin.ru 'bash -s' << 'EOF'
        cd /home/vboxuser/devops-app
        
        DEPLOY_TIME=$(date '+%Y-%m-%d %H:%M:%S')
        
        # Останавливаем сервис и очищаем порт
        echo "=== Stopping service and cleaning port 8181 ==="
        sudo systemctl stop devops-app.service || true
        sudo pkill -f "python.*app.py" || true
        sleep 3
        sudo fuser -k 8181/tcp || true
        sleep 2
        
        # Создаем systemd сервис
        sudo tee /etc/systemd/system/devops-app.service > /dev/null << 'SERVICEEOF'
        [Unit]
        Description=DevOps Lab Application
        After=network.target

        [Service]
        Type=simple
        User=vboxuser
        WorkingDirectory=/home/vboxuser/devops-app
        Environment=DEPLOY_TIME=$DEPLOY_TIME
        ExecStart=/usr/bin/python3 /home/vboxuser/devops-app/app.py
        Restart=on-failure
        RestartSec=5
        StandardOutput=journal
        StandardError=journal

        [Install]
        WantedBy=multi-user.target
        SERVICEEOF

        sudo systemctl daemon-reload
        sudo systemctl enable devops-app.service
        sudo systemctl start devops-app.service
        
        # Даем БОЛЬШЕ времени на запуск
        echo "=== Waiting for application to start (15 seconds) ==="
        sleep 15
        
        # Проверяем статус
        echo "=== Service status ==="
        sudo systemctl status devops-app.service --no-pager
        
        # Проверяем что процесс запустился
        if pgrep -f "python.*app.py" > /dev/null; then
          echo "Process is running"
        else
          echo "Process not running"
          sudo journalctl -u devops-app.service -n 10 --no-pager
          exit 1
        fi
        
        # Проверяем что приложение ОТВЕЧАЕТ на запросы
        echo "=== Testing application response ==="
        if curl -f --retry 3 --retry-delay 2 http://localhost:8181 > /dev/null 2>&1; then
          echo "Application is responding on port 8181!"
          echo "Deployed at: $DEPLOY_TIME"
        else
          echo "Application not responding on port 8181"
          echo "=== Checking port ==="
          sudo lsof -i :8181 || echo "Port 8181 status unknown"
          echo "=== Recent logs ==="
          sudo journalctl -u devops-app.service -n 15 --no-pager
          exit 1
        fi
        EOF