name: CD

on:
  release:
    types: [published]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Deploy to server
      uses: appleboy/ssh-action@v1
      with:
        host: course.prafdin.ru
        username: vboxuser
        port: 2425
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "Starting deployment..."
          cd /home/vboxuser
          
          # Останавливаем предыдущий процесс если запущен
          pkill -f "python.*app.py" || true
          sleep 2
          
          # Обновляем код
          if [ -d "devops-lab1" ]; then
            cd devops-lab1
            git pull origin main
          else
            git clone https://github.com/RomanDik/devops_2.git devops-lab1
            cd devops-lab1
          fi
          
          # Запускаем приложение в фоне
          nohup python app.py > app.log 2>&1 &
          echo "✓ Application deployed and running on port 8181"
          
          # Проверяем что процесс запустился
          sleep 3
          pgrep -f "python.*app.py" && echo "✓ Process is running" || echo "✗ Process failed to start"